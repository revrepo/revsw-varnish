From 636d6b0b58cefd2c53adc7910f205285c2801edd Mon Sep 17 00:00:00 2001
From: vimal gupta <vimal.gupta@techvedika.com>
Date: Fri, 19 Dec 2014 15:58:51 +0530
Subject: [PATCH 18/63] Added filter_only function to the vmod

---
 libvmod-cookie-4.0/src/vmod_cookie.c   | 41 ++++++++++++++++++++++++++++++++++
 libvmod-cookie-4.0/src/vmod_cookie.vcc |  1 +
 2 files changed, 42 insertions(+)

diff --git a/libvmod-cookie-4.0/src/vmod_cookie.c b/libvmod-cookie-4.0/src/vmod_cookie.c
index dc30cc3..8a8f9ea 100644
--- a/libvmod-cookie-4.0/src/vmod_cookie.c
+++ b/libvmod-cookie-4.0/src/vmod_cookie.c
@@ -263,6 +263,47 @@ vmod_filter_except(const struct vrt_ctx *ctx, VCL_STRING whitelist) {
 }
 
 
+VCL_VOID
+vmod_filter_only(const struct vrt_ctx *ctx, VCL_STRING blacklist) {
+        char cookienames[MAX_COOKIEPART][MAXCOOKIES];
+        char tmpstr[MAX_COOKIESTRING];
+        struct cookie *cookie, *tmp;
+        char *tokptr, *saveptr;
+        int i, found = 0, num_cookies = 0;
+        struct vmod_cookie *vcp = cobj_get(ctx);
+        CHECK_OBJ_NOTNULL(vcp, VMOD_COOKIE_MAGIC);
+
+        strcpy(tmpstr, (char *)blacklist);
+        tokptr = strtok_r(tmpstr, ",", &saveptr);
+        if (!tokptr) return;
+
+        // parse the blacklist.
+        while (1) {
+                strcpy(cookienames[num_cookies], tokptr);
+                num_cookies++;
+
+                tokptr = strtok_r(NULL, ",", &saveptr);
+                if (!tokptr) break;
+        }
+
+        // filter existing cookies that are in the blacklist.
+        VTAILQ_FOREACH_SAFE(cookie, &vcp->cookielist, list, tmp) {
+                found = 0;
+                for (i = 0; i < num_cookies; i++) {
+                        if (strlen(cookie->name) == strlen(cookienames[i]) &&
+                            strcmp(cookienames[i], cookie->name) == 0) {
+                                found = 1;
+                                break;
+                        }
+                }
+
+                if (found) {
+                        VTAILQ_REMOVE(&vcp->cookielist, cookie, list);
+                }
+        } // foreach
+}
+
+
 VCL_STRING
 vmod_get_string(const struct vrt_ctx *ctx) {
 	struct cookie *curr;
diff --git a/libvmod-cookie-4.0/src/vmod_cookie.vcc b/libvmod-cookie-4.0/src/vmod_cookie.vcc
index 2005ba7..5329f1b 100644
--- a/libvmod-cookie-4.0/src/vmod_cookie.vcc
+++ b/libvmod-cookie-4.0/src/vmod_cookie.vcc
@@ -7,5 +7,6 @@ $Function STRING get(STRING)
 $Function BOOL isset(STRING)
 $Function VOID delete(STRING)
 $Function VOID filter_except(STRING)
+$Function VOID vmod_filter_only(STRING)
 $Function STRING get_string()
 $Function STRING format_rfc1123(TIME, DURATION)
-- 
2.7.4

