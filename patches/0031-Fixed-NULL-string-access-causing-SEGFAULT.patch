From 6e4abafefaaf2afa9e1761693341560c203c5680 Mon Sep 17 00:00:00 2001
From: sorinrevsw <sorin.revsw@gmail.com>
Date: Wed, 31 Dec 2014 10:18:34 +0200
Subject: [PATCH 31/63] Fixed NULL string access causing SEGFAULT.

---
 debian/changelog                     | 6 ++++++
 libvmod-revvar-4.0/src/vmod_revvar.c | 2 +-
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/debian/changelog b/debian/changelog
index d512f1e..406d516 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -1,3 +1,9 @@
+revsw-varnish4-modules (0.5-3) unstable; urgency=medium
+
+  * Fixed NULL string access causing SEGFAULT.
+
+ -- Sorin Otescu <sorin@revsw.com>  Wed, 31 Dec 2014 10:17:52 +0200
+
 revsw-varnish4-modules (0.5-2) unstable; urgency=medium
 
   * Updated 'cookie' VMOD from original repo.
diff --git a/libvmod-revvar-4.0/src/vmod_revvar.c b/libvmod-revvar-4.0/src/vmod_revvar.c
index d39c98d..f524b7f 100644
--- a/libvmod-revvar-4.0/src/vmod_revvar.c
+++ b/libvmod-revvar-4.0/src/vmod_revvar.c
@@ -112,7 +112,7 @@ _duplicate_vars(struct ws *ws, void *data)
             /* We must copy the string into our own ws.
                STRING_LITERAL doesn't need to be copied, because it's a static value
                defined at compile time. */
-            if (v->type == STRING)
+            if (v->type == STRING && v->value.STRING)
                 v->value.STRING = WS_Copy(ws, v->value.STRING, -1);
         }
     }
-- 
2.7.4

