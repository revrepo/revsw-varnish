From b3b37a0c63f3cfeedc5b31dc2d48c7d76079cd71 Mon Sep 17 00:00:00 2001
From: sorinrevsw <sorin@revsw.com>
Date: Mon, 25 May 2015 20:58:11 +0300
Subject: [PATCH 40/63] Various fixes for Vanrish 4.0.3 switch.

---
 debian/changelog                 |  6 ++++++
 debian/control                   |  6 +++---
 debian/rules                     |  2 +-
 libvmod-header-4.0/m4/varnish.m4 | 12 ++++++++----
 4 files changed, 18 insertions(+), 8 deletions(-)

diff --git a/debian/changelog b/debian/changelog
index df1a0c4..70446d3 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -1,3 +1,9 @@
+revsw-varnish4-modules (0.5-8) unstable; urgency=medium
+
+  * Updated Varnish to 4.0.3.
+
+ -- Sorin Otescu <sorin@revsw.com>  Mon, 25 May 2015 19:19:51 +0300
+
 revsw-varnish4-modules (0.5-7) unstable; urgency=medium
 
   * Added 'req_processing_time_real' to 'timers' VMOD.
diff --git a/debian/control b/debian/control
index 4dc12e9..96b5898 100644
--- a/debian/control
+++ b/debian/control
@@ -3,13 +3,13 @@ Section: web
 Priority: extra
 Maintainer: Sorin Otescu <sorin@revsw.com>
 Build-Depends: debhelper (>= 7), build-essential, python-docutils,
- revsw-libvarnish4api-dev (>= 4.0.2)
-Built-Using: revsw-varnish4 (= 4.0.2)
+ revsw-libvarnish4api-dev (>= 4.0.3)
+Built-Using: revsw-varnish4 (= 4.0.3)
 Standards-Version: 3.8.1
 
 Package: revsw-varnish4-modules
 Architecture: any
-Depends: revsw-varnish4 (>= 4.0.2), ${Varnish:ABI}, ${misc:Depends}
+Depends: revsw-varnish4 (>= 4.0.3), ${Varnish:ABI}, ${misc:Depends}
 Conflicts: revsw-varnish-modules
 Replaces: revsw-varnish-modules
 Description: Various VMODs for Varnish
diff --git a/debian/rules b/debian/rules
index debfcd3..f36b4d8 100755
--- a/debian/rules
+++ b/debian/rules
@@ -1,7 +1,7 @@
 #!/usr/bin/make -f
 export DH_VERBOSE=1
 
-VARNISHSRC := $(shell readlink -f ../varnish-4.0.2)
+VARNISHSRC := $(shell readlink -f ../varnish-4.0.3)
 VMODDIR := /usr/lib/varnish/vmods
 VMOD_ABI := $(shell printf '\#include "vmod_abi.h"\nVMOD_ABI_Version' | cpp - -I$(VARNISHSRC)/include | sed '/^\#/D;s/"//g;s/\([A-Z]\)/\L\1/g;s/[^a-z0-9.]/-/g;s/varnish/varnishabi/')
 
diff --git a/libvmod-header-4.0/m4/varnish.m4 b/libvmod-header-4.0/m4/varnish.m4
index 16e27c5..8339cb0 100644
--- a/libvmod-header-4.0/m4/varnish.m4
+++ b/libvmod-header-4.0/m4/varnish.m4
@@ -1,7 +1,7 @@
 # varnish.m4 - Macros to locate Varnish header files.            -*- Autoconf -*-
-# serial 1 (varnish-4.0)
+# serial 3 (varnish-4.0)
 
-# Copyright (c) 2013 Varnish Software AS
+# Copyright (c) 2013-2015 Varnish Software AS
 # All rights reserved.
 #
 # Author: Tollef Fog Heen <tfheen@varnish-software.com>
@@ -28,6 +28,11 @@
 # SUCH DAMAGE.
 #
 
+# For compatibility with autoconf < 2.63b
+m4_ifndef([AS_VAR_COPY],
+  [m4_define([AS_VAR_COPY],
+     [AS_LITERAL_IF([$1[]$2], [$1=$$2], [eval $1=\$$2])])]) 
+
 # VARNISH_VMOD_INCLUDE_DIR([])
 # ----------------------------
 
@@ -53,10 +58,9 @@ variable if you installed software in a non-standard prefix.])
 	fi
 ])
 
-VARNISH_PKG_GET_VAR([VMOD_INCLUDE_DIR], [vmodincludedir])
 VARNISH_PKG_GET_VAR([VAPI_INCLUDE_DIR], [pkgincludedir])
 _CPPFLAGS="$CPPFLAGS"
-VMOD_INCLUDES="-I$VMOD_INCLUDE_DIR -I$VAPI_INCLUDE_DIR"
+VMOD_INCLUDES="-I$VAPI_INCLUDE_DIR"
 CPPFLAGS="$VMOD_INCLUDES $CPPFLAGS"
 AC_CHECK_HEADERS([vsha256.h cache/cache.h])
 CPPFLAGS="$_CPPFLAGS"
-- 
2.7.4

