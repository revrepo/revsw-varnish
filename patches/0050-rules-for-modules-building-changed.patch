From 253795662e843d5354398063a7b1d1a6debbed67 Mon Sep 17 00:00:00 2001
From: Yegor Dia <TheDialord@users.noreply.github.com>
Date: Thu, 11 Aug 2016 05:54:24 +0100
Subject: [PATCH 50/63] rules for modules building changed

---
 varnish4-vmods/debian/rules  |  4 ++++
 varnish4-vmods/debian/rules~ | 57 ++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 61 insertions(+)
 create mode 100755 varnish4-vmods/debian/rules~

diff --git a/varnish4-vmods/debian/rules b/varnish4-vmods/debian/rules
index f36b4d8..62f1b24 100755
--- a/varnish4-vmods/debian/rules
+++ b/varnish4-vmods/debian/rules
@@ -16,6 +16,7 @@ override_dh_auto_configure:
 	cd libvmod-revvar-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
 	cd libvmod-header-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
 	cd libvmod-timers-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
+	cd libvmod-var-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
 
 override_dh_gencontrol:
 	echo "Varnish:ABI=$(VMOD_ABI)" >> debian/substvars
@@ -33,6 +34,7 @@ override_dh_auto_build:
 	$(MAKE) -C libvmod-revvar-4.0
 	$(MAKE) -C libvmod-header-4.0
 	$(MAKE) -C libvmod-timers-4.0
+	$(MAKE) -C libvmod-var-4.0
 
 override_dh_auto_install:
 	$(MAKE) -C libvmod-querystring-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
@@ -41,6 +43,7 @@ override_dh_auto_install:
 	$(MAKE) -C libvmod-revvar-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
 	$(MAKE) -C libvmod-header-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
 	$(MAKE) -C libvmod-timers-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
+	$(MAKE) -C libvmod-var-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
 
 override_dh_auto_clean:
 	$(MAKE) -C libvmod-querystring-4.0 distclean || true
@@ -49,6 +52,7 @@ override_dh_auto_clean:
 	$(MAKE) -C libvmod-revvar-4.0 distclean || true
 	$(MAKE) -C libvmod-header-4.0 distclean || true
 	$(MAKE) -C libvmod-timers-4.0 distclean || true
+	$(MAKE) -C libvmod-var-4.0 distclean || true
 
 override_dh_strip:
 	dh_strip --dbg-package=revsw-varnish4-modules-dbg
diff --git a/varnish4-vmods/debian/rules~ b/varnish4-vmods/debian/rules~
new file mode 100755
index 0000000..f36b4d8
--- /dev/null
+++ b/varnish4-vmods/debian/rules~
@@ -0,0 +1,57 @@
+#!/usr/bin/make -f
+export DH_VERBOSE=1
+
+VARNISHSRC := $(shell readlink -f ../varnish-4.0.3)
+VMODDIR := /usr/lib/varnish/vmods
+VMOD_ABI := $(shell printf '\#include "vmod_abi.h"\nVMOD_ABI_Version' | cpp - -I$(VARNISHSRC)/include | sed '/^\#/D;s/"//g;s/\([A-Z]\)/\L\1/g;s/[^a-z0-9.]/-/g;s/varnish/varnishabi/')
+
+LOCAL_CFLAGS := -g3
+#LOCAL_CFLAGS := -O0 -g3
+LOCAL_LDFLAGS := -g3
+
+override_dh_auto_configure:
+	cd libvmod-querystring-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
+	cd libvmod-chromelogger-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
+	cd libvmod-cookie-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
+	cd libvmod-revvar-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
+	cd libvmod-header-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
+	cd libvmod-timers-4.0 && ./autogen.sh && CFLAGS="$(LOCAL_CFLAGS)" LDFLAGS="$(LOCAL_LDFLAGS)" ./configure --prefix=/usr --datarootdir=/usr/share --disable-static VMODDIR="$(VMODDIR)" VARNISHSRC="$(VARNISHSRC)"
+
+override_dh_gencontrol:
+	echo "Varnish:ABI=$(VMOD_ABI)" >> debian/substvars
+
+	if [ -n "$$DEBIAN_OVERRIDE_BINARY_VERSION" ]; then \
+		dh_gencontrol -- -Tdebian/substvars -v$$DEBIAN_OVERRIDE_BINARY_VERSION; \
+	else \
+		dh_gencontrol -- -Tdebian/substvars; \
+	fi
+
+override_dh_auto_build:
+	$(MAKE) -C libvmod-querystring-4.0
+	$(MAKE) -C libvmod-chromelogger-4.0
+	$(MAKE) -C libvmod-cookie-4.0
+	$(MAKE) -C libvmod-revvar-4.0
+	$(MAKE) -C libvmod-header-4.0
+	$(MAKE) -C libvmod-timers-4.0
+
+override_dh_auto_install:
+	$(MAKE) -C libvmod-querystring-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
+	$(MAKE) -C libvmod-chromelogger-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
+	$(MAKE) -C libvmod-cookie-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
+	$(MAKE) -C libvmod-revvar-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
+	$(MAKE) -C libvmod-header-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
+	$(MAKE) -C libvmod-timers-4.0 DESTDIR=$$(pwd)/debian/revsw-varnish4-modules install
+
+override_dh_auto_clean:
+	$(MAKE) -C libvmod-querystring-4.0 distclean || true
+	$(MAKE) -C libvmod-chromelogger-4.0 distclean || true
+	$(MAKE) -C libvmod-cookie-4.0 distclean || true
+	$(MAKE) -C libvmod-revvar-4.0 distclean || true
+	$(MAKE) -C libvmod-header-4.0 distclean || true
+	$(MAKE) -C libvmod-timers-4.0 distclean || true
+
+override_dh_strip:
+	dh_strip --dbg-package=revsw-varnish4-modules-dbg
+
+%:
+	dh $@
-- 
2.7.4

